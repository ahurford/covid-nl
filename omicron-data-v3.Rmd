---
title: "COVID-19 in Newfoundland and Labrador"
author: "Dr. Amy Hurford"
output:
  html_document: default
  word_document: default
  pdf_document: default
fontsize: 11pt
---
[Memorial University of Newfoundland and Labrador,](https://www.mun.ca/math/)
[Canadian Network for Modelling Infectious Disease,](https://canmod.net/)
[Mathematics for Public Health,](http://www.fields.utoronto.ca/activities/public-health)
[One Health Modelling Network for Emerging Infections](https://www.yorku.ca/science/cdm/2021/04/09/ccdm-network-to-model-emerging-infectious-diseases-receives-2-5-million-in-federal-funding/)

```{r setup, include=FALSE}
require(zoo)
require(ggplot2)
require(patchwork)
require(dplyr)
gg_color_hue <- function(n){
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
n = 8
cols = gg_color_hue(n)
#data=read.csv("~/Desktop/RHA_DailyData_Original_Public.csv")
data <- read.csv('https://raw.githubusercontent.com/ahurford/covid-nl/master/NL-Hub/RHA_DailyData_Original_Public.csv', fill=TRUE)
data1<-data
data2 = data.frame(date=as.Date(data$date_updated), cases = data$new_cases, tests = data$total_people_tested, RHA = data$regional_health_authority)
data2 = data2[data2$date>"2021-12-10",]
eastern = data2[data2$RHA=="eastern_rha",]
western = data2[data2$RHA=="western_rha",]
central = data2[data2$RHA=="central_rha",]
labrador = data2[data2$RHA=="labradorgrenfell_rha",]
#error not cumulative
labrador$tests[51] = labrador$tests[51]+labrador$tests[50]

row.names(eastern) <- NULL
row.names(central)<-NULL
row.names(western)<-NULL
row.names(labrador)<-NULL

# correct flaws in data
eastern$tests[31] = eastern$tests[31]+eastern$tests[30]
# repeated days or non-sensical test numbers
eastern = eastern[-c(44,28,35),]
western = western[-43,]
central = central[-c(44,28,52),]
# Number of tests not reported on entry 38
labrador = labrador[-c(44,28,38),]

smoothdata = function(){
T = length(values[,1])
difference <- c(1,as.double(difftime(values$date[2:T],values$date[1:(T-1)],units='days')))
# Cases per day since last reporting
values$tests = diff(c(0,values$tests))/difference
values$cases = values$cases
values = cbind(values,difference=difference,positivity=values$cases/values$tests)
dates = seq(as.Date("2021-12-14"), values$date[T], by="days")

cases = NULL
tests = NULL
positivity = NULL

ii = NULL
for(i in seq(1,(T-1))){
  cases = c(cases,rep(values$cases[(i+1)],difference[(i+1)]))
  tests = c(tests,rep(values$tests[(i+1)],difference[(i+1)]))
  positivity = c(positivity,rep(values$positivity[(i+1)],difference[(i+1)]))
}

cases = tail(cases,-1)
tests = tail(tests,-1)
positivity = tail(positivity,-1)

values = data.frame(dates=tail(dates,-1), cases=cases, tests=tests, positivity = positivity)

# 14 day rolling mean:
values.roll = data.frame(cases = rollmean(cases,14), tests = rollmean(tests,14), positivity = rollmean(positivity,14))
n=0.5
undetected = popn.size*((values.roll$cases/popn.size)^n*(values.roll$positivity)^(1-n))


cases.raw = values$cases
test.raw = values$tests
active = rollsumr(values.roll$cases, k = 7, fill = NA)
active[1:6] = cumsum(values.roll$cases[1:6])
data = data.frame(dates2 = tail(dates,-1), tests.roll = c(rep(NA,13),values.roll$tests), detected.roll = c(rep(NA,13),values.roll$cases), all = c(rep(NA,7),undetected+active, rep(NA,6)), cases.raw = cases.raw, test.raw = test.raw, positivity.roll = c(rep(NA,13),values.roll$positivity), positivity.raw = cases.raw/test.raw, active=c(rep(NA,7),active,rep(NA,6)))
return(data)
}

values <- eastern
popn.size <- 10000*data1[data1$regional_health_authority=="eastern_rha",]$Population[1]
data = smoothdata()
eastern = data
eastern.pop = popn.size

gE=ggplot() +
  geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=100*all/eastern.pop),lwd=2, col = cols[1])+
  geom_point(data=data[!is.na(data$active),],aes(x=as.Date(dates2), y=100*active/eastern.pop), col = cols[1], size=.5)+
  xlab("")+
  ylab("active cases\n(% of EH population)")+
  ggtitle("Eastern Health")+
  theme_classic()+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")
##

values <- central
popn.size <- 10000*data1[data1$regional_health_authority=="central_rha",]$Population[1]
data = smoothdata()
central = data
central.pop = popn.size

gC=ggplot() +
  geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=100*all/central.pop),lwd=2, col = cols[2])+
  geom_point(data=data[!is.na(data$active),],aes(x=as.Date(dates2), y=100*active/central.pop), col = cols[2], size=.5)+
  xlab("")+
  ylab("active cases\n(% of CH population)")+
  ggtitle("Central Health")+
  theme_classic()+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")
##

values <- western
popn.size <- 10000*data1[data1$regional_health_authority=="western_rha",]$Population[1]
data = smoothdata()
western = data
western.pop = popn.size

gW=ggplot() +
  geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=100*all/western.pop),lwd=2, col = cols[3])+
  geom_point(data=data[!is.na(data$active),],aes(x=as.Date(dates2), y=100*active/western.pop), col = cols[3], size=.5)+
  xlab("")+
  ylab("active cases\n(% of WH population)")+
  ggtitle("Western Health")+
  theme_classic()+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")
##

values <- labrador
popn.size <- 10000*data1[data1$regional_health_authority=="labradorgrenfell_rha",]$Population[1]
data = smoothdata()
labrador = data
labrador.pop = popn.size

gL=ggplot() +
  geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=100*all/labrador.pop),lwd=2, col = cols[4])+
  geom_point(data=data[!is.na(data$active),],aes(x=as.Date(dates2), y=100*active/labrador.pop), col = cols[4], size=.5)+
  xlab("")+
  ylab("active cases\n(% of LGH population)")+
  ggtitle("Labrador-Grenfell Health")+
  theme_classic()+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")
##

## NL totals from Data hub 
cases.raw.hub = eastern$cases.raw + western$cases.raw + central$cases.raw + labrador$cases.raw
test.raw.hub = eastern$test.raw + western$test.raw + central$test.raw + labrador$test.raw
all.hub = eastern$all + western$all + central$all + labrador$all
positivity.roll.hub = c(rep(NA,13),rollmean(cases.raw.hub/test.raw.hub, 14))
detected.roll.hub = c(rep(NA,13),rollmean(cases.raw.hub, 14))
active.hub = eastern$active + western$active + central$active + labrador$active


# Load data from PSAs
NL <- read.csv('https://raw.githubusercontent.com/ahurford/covid-nl/master/NL.csv', fill=TRUE)
NL.tests <- read.csv('https://raw.githubusercontent.com/ahurford/covid-nl/master/Test_NL(twosources).csv', fill=TRUE)
NL.tests$date <- format(as.Date(NL.tests$date, format="%m/%d/%Y"), "%Y-%m-%d")

NL.tests <- NL.tests %>% filter(!is.na(total.test))
T = length(NL.tests[,1])
difference <- c(1,as.double(difftime(NL.tests$date[2:T],NL.tests$date[1:(T-1)],units='days')))
tests1 <- diff(c(0,NL.tests$total.test))/difference
# Fill for missing dates
tests=NULL
for(i in seq(1,(T))){
  tests = c(tests,rep(tests1[(i)],difference[(i)]))
}
tests = cumsum(tests)
T = length(NL[,1])
difference <- c(1,as.double(difftime(NL$date[2:T],NL$date[1:(T-1)],units='days')))
# Fill for missing dates
cases=NULL
for(i in seq(1,(T))){
  cases = c(cases,rep(NL$total[(i)],difference[(i)]))
}
dates = seq(as.Date("2021-12-13"), as.Date(NL$date[T]), by="days")
NL = data.frame(date=dates, cases=cases, tests=tests)
values <- NL
popn.size <- 10000*(data1[data1$regional_health_authority=="labradorgrenfell_rha",]$Population[1]+data1[data1$regional_health_authority=="central_rha",]$Population[1]+data1[data1$regional_health_authority=="western_rha",]$Population[1]+data1[data1$regional_health_authority=="eastern_rha",]$Population[1])
data = smoothdata()
NL = data

data = cbind(data, detected.roll.hub = detected.roll.hub, all.hub = all.hub, positivity.roll.hub = positivity.roll.hub, cases.raw.hub=cases.raw.hub, test.raw.hub = test.raw.hub, active.hub)


gNL=ggplot() +
  #geom_point(data=data, aes(x=as.Date(dates2), y=100*cases.raw/max(cases.raw)), col = cols[1], size=1)+
#geom_point(data=data, aes(x=as.Date(dates2), y=100*(cases.raw/test.raw)/max(cases.raw/test.raw)), col = "grey", size=1)+
  geom_point(data=data[!is.na(data$detected.roll),], aes(x=as.Date(dates2), y=100*detected.roll/max(detected.roll)), col = cols[5], size=1)+
  geom_point(data=data[!is.na(data$positivity.roll),],aes(x=as.Date(dates2), y=100*positivity.roll/max(positivity.roll)),size=1,col = "grey")+
  geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=100*all/max(all)),lwd=2, col = cols[5])+
  xlab("")+
  ylab("% of maximum")+
  ggtitle("Newfoundland and Labrador")+
  annotate("text", x = as.Date("2022-03-02"), y = 89, label = "positivity", col="grey")+
  annotate("text", x = as.Date("2022-02-18"), y = 60, label = "total active cases",fontface=2, col=cols[5])+
  annotate("text", x = as.Date("2022-02-24"), y = 35, label = "reported new cases", col=cols[5])+
  theme_classic()+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")

gNL.active=ggplot() +
  geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=100*all.hub/popn.size),lwd=2, col = cols[6])+
  geom_point(data=data[!is.na(data$active),],aes(x=as.Date(dates2), y=100*active.hub/popn.size), pch=8, col = cols[6], size=2)+
    geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=100*all/popn.size),lwd=2, col = cols[5])+
  geom_point(data=data[!is.na(data$active),],aes(x=as.Date(dates2), y=100*active/popn.size), col = cols[5], size=2)+
  annotate("text", x = as.Date("2022-02-14"), y = 0.55, label = "reported active cases")+
  annotate("text", x = as.Date("2022-02-14"), y = 1.6, label = "total active cases")+
  xlab("")+
  ylab("active cases (% of NL population)")+
  ggtitle("Newfoundland and Labrador")+
  theme_classic()+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")

g.ratio=ggplot() +
  geom_hline(yintercept=2, col="grey")+
  geom_hline(yintercept=3, col="grey")+
  geom_hline(yintercept=5.4, col="grey")+
  xlab("")+
  annotate("text", x = as.Date(tail(data$dates2,1)), y = 2.6, label = "CITF pre-Omicron",size=3.5, hjust=1)+
  annotate("text", x = as.Date(tail(data$dates2,1)), y = 1.9, label = "hosp. admissions (low)",size=3.5, hjust=1)+
  annotate("text", x = as.Date(tail(data$dates2,1)), y = 2.9, label = "hosp. admissions (high)",size=3.5, hjust=1)+
  annotate("text", x = as.Date(tail(data$dates2,1)), y = 5.3, label = "K-12 RAT study",size=3.5, hjust=1)+
  geom_hline(yintercept=2.7, col="grey")+
  xlab("")+
  geom_line(data=data[!is.na(data$all),],aes(x=as.Date(dates2), y=all/active),lwd=2, col = cols[5])+
  geom_line(data=data[!is.na(data$all.hub),],aes(x=as.Date(dates2), y=all.hub/active.hub),lwd=2, col = cols[6])+
  ylim(0,6)+
  ylab("Number of unreported cases per reported case")+
  ggtitle("Newfoundland and Labrador")+
  theme_classic()+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")



gNL2=ggplot() +
  geom_line(data=data, aes(x=as.Date(dates2), y=data$detected.roll.hub), col = cols[6],lwd=2)+
  geom_point(data=data, aes(x=as.Date(dates2), y=data$cases.raw.hub), pch=8, col=cols[6])+
  geom_point(data=data, aes(x=as.Date(dates2), y=data$cases.raw), col = cols[5])+
  geom_line(data=data, aes(x=as.Date(dates2), y=data$detected.roll), col = cols[5],lwd=2)+
  xlab("")+
  ylab("Reported new cases")+
  ggtitle("Newfoundland and Labrador")+
  theme_classic()+
  ylim(c(0,max(data$cases.raw, data$detected.roll)))+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")

gNL2b=ggplot() +
  geom_line(data=data, aes(x=as.Date(dates2), y=100*data$positivity.roll.hub), col=cols[6],lwd=2)+
  geom_point(data=data, aes(x=as.Date(dates2), y=100*cases.raw.hub/test.raw.hub), pch=8, col = cols[6])+
  geom_point(data=data, aes(x=as.Date(dates2), y=100*cases.raw/test.raw), col = cols[5])+
  geom_line(data=data, aes(x=as.Date(dates2), y=100*data$positivity.roll), col = cols[5],lwd=2)+
  xlab("")+
  ylab("Positivity (%)")+
  ggtitle("Newfoundland and Labrador")+
  theme_classic()+
  ylim(c(0,max(data$cases.raw, data$detected.roll)))+
  scale_x_date(date_breaks = "7 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none")

gNL3=ggplot() +
  geom_line(data=tail(data, 14), aes(x=as.Date(dates2), y=cases.raw.hub))+
  geom_point(data=tail(data, 14), aes(x=as.Date(dates2), y=cases.raw.hub), pch=8)+
  geom_point(data=tail(data, 14), aes(x=as.Date(dates2), y=cases.raw), col = cols[5])+
  geom_line(data=tail(data, 14), aes(x=as.Date(dates2), y=cases.raw), col = cols[5])+
  xlab("")+
  ylab("Reported new cases")+
  ggtitle("Newfoundland and Labrador (last 14 days)")+
  theme_classic()+
  ylim(c(0,max(tail(data$cases.raw,14), tail(data$detected.roll, 14))))+
  scale_x_date(date_breaks = "1 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none", plot.title = element_text(size=10))

gNL3b=ggplot() +
  geom_line(data=tail(data,14), aes(x=as.Date(dates2), y=test.raw.hub))+
  geom_point(data=tail(data,14), aes(x=as.Date(dates2), y=test.raw.hub), pch=8)+
  geom_point(data=tail(data,14), aes(x=as.Date(dates2), y=test.raw), col = cols[5])+
  geom_line(data=tail(data,14), aes(x=as.Date(dates2), y=test.raw), col = cols[5])+
  xlab("")+
  ylab("Reported tests")+
  ggtitle("Newfoundland and Labrador (last 14 days)")+
  theme_classic()+
  ylim(c(0,max(data$cases.raw, data$detected.roll)))+
  scale_x_date(date_breaks = "1 day", date_labels = "%d %b")+
  theme(axis.text.x = element_text(angle = 90),legend.position = "none", plot.title = element_text(size=10))
```

## {}

### Are cases increasing?

**Yes.** That cases are increasing was stated by Dr. Fitzgerald in briefings on February 23 and March 1. Reported new cases have been increasing, as has the percentage of positive test results (Figure 1).

```{r,echo=F, warning=FALSE}
gNL2+gNL2b
```

**Figure 1. Reported new cases (left) and percent positivity (right) from two public data sources**. The data sources are the [Department of Health and Community Services Public Advisories](https://www.gov.nl.ca/releases/covid-19-news/) (<u>blue</u> - dots: raw data; line: 14-day average) and the [Newfoundland and Labrador COVID-19 Pandemic Update Hub](https://geohub-gnl.hub.arcgis.com/search?q=COVID) (<u>aqua</u> - astericks: raw data; line: 14-day average). There is some disagreement between the data sources in January, when hundreds of test results completed out-of-province were reported. For the [Department of Health and Community Services Public Advisories](https://www.gov.nl.ca/releases/covid-19-news/) data (manually curated) these cases were assigned to the day they were reported.  

### How should I understand my risk for becoming infected?

The risk of becoming infected depends on your vaccination status and other factors. An additional consideration is the total number of active infections (both reported and unreported; Figure 2 solid line). Currently, the total number of active infections is **increasing.** 

```{r,echo=F, warning=FALSE}
gNL.active
```

**Figure 2. Reported (symbols) and total active cases (line) as a percentage of the population of Newfoundland and Labrador.** The number of unreported cases is estimated as described [here](#Methods). Colours denote two different data sources (see Figure 1 caption).


### How many cases are not reported?

I estimate that on `r format(head(tail(round(data$dates2),7),1), "%b %d")` , there were **`r round(head(tail(data$all/data$active,7),1),1)` unreported cases per reported case** (Figure 3).

```{r,echo=F, warning=FALSE}
g.ratio
```

**Figure 3. The number of unreported cases per reported case.** The geometric mean method (coloured lines; described [here](#Methods)) is compared to other estimates: _K-12 RAT survey_ refers to rapid antigen testing of K-12 students performed on January 22 and 25 (see [here](https://www.mun.ca/science/school-test/)); _CITF pre-Omicron_ is an estimate from the [COVID Immunity Taskforce](https://www.covid19immunitytaskforce.ca/seroprevalence-modelling/) for Atlantic Canada prior to the establishment of the Omicron variant; _Hospital admissions (low) and (high)_ are values given by Dr. Fitzgerald during media briefings from testing of all hospital admissions. Colours denote two different data sources (see Figure 1 caption).

### Are there differences between Regional Health Authorities?

```{r,echo=F, warning=FALSE}
gE+gC+gW+gL
```

**Figure 4. Reported (symbols) and total active cases (line) as a percentage of the population of each Regional Health Authority.** Data are from the [Newfoundland and Labrador COVID-19 Pandemic Update Hub](https://geohub-gnl.hub.arcgis.com/search?q=COVID) as the public advisories do not report test numbers for each Regional Health Authority. See Figure 2 caption for additional details.


```{r, include=F}
last7 = data.frame(date = tail(data$dates2,7), data.hub.cases = tail(data$cases.raw.hub,7), PSA.cases = tail(data$cases.raw,7), data.hub.tests = tail(data$test.raw.hub,7), PSA.tests = tail(data$test.raw,7))
```

### What data am I using?

Below is tha print out of the last 7 days of data. These should match with the [Newfoundland and Labrador COVID-19 Pandemic Update Hub](https://geohub-gnl.hub.arcgis.com/search?q=COVID) and the [Department of Health and Community Services Public Advisories](https://www.gov.nl.ca/releases/covid-19-news/).

```{r,echo=F}
last7
```


### Methods {#Methods}
I estimate the prevalence of unreported cases 7-days ago as the geometric mean of the per capita reported new cases (14-day rolling average), and the proportion of tests that are positive (14-day rolling average; see [Chui and Ndeffo-Mbah (2021)](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1009374) for details).